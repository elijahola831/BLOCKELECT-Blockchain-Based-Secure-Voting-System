<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Voting ‚Äï BLOCKELECT</title>
    <meta name="description" content="Secure blockchain-based electronic voting system with advanced analytics and privacy features">
    <meta name="theme-color" content="#0d6efd">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/pwa-icon-192.png">
    <link rel="stylesheet" type="text/css" href="css/index.css">
    <link rel="stylesheet" type="text/css" href="icons/bootstrap-icons.css">
    <link rel="shortcut icon" href="assets/favicon.svg" type="image/x-icon">
    <link rel="stylesheet" href="/css/alert.css">
    <script src="/js/alert.js" defer></script>
</head>

<body>
    <video autoplay muted loop>
        <source src="assets/blockchain.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <div id="content">
        <a href="/"><img src="assets/logo.svg" alt="BLOCKELECT Logo"></a>
        <small class="tagline">A Secure Voting System Based on the Ethereum Blockchain</small>

        <main id="page">
            <div id="accountBox">
                <div id="account">
                    <p id="acctLabel">
                        <i class="bi bi-person-circle"></i>
                        <b>Your Acct:</b>
                    <p id="acctAddress"></p>
                    </p>
                    <p id="acctType"></p>
                </div>
                <!-- Biometric Authentication Button -->
                <div style="margin-top: 15px; text-align: center;">
                    <button id="biometric-btn" 
                            style="background: linear-gradient(45deg, #007bff, #0056b3); color: white; 
                                   border: none; padding: 10px 20px; border-radius: 25px; font-weight: bold; 
                                   cursor: pointer; box-shadow: 0 3px 10px rgba(0,123,255,0.3); 
                                   transition: all 0.3s ease; font-size: 14px; margin: 5px;"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(0,123,255,0.4)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(0,123,255,0.3)'"
                            onclick="openBiometricAuth()">
                        üîê Enable Biometric Login
                    </button>
                    <button onclick="testBiometricButton()" 
                            style="background: #6c757d; color: white; border: none; padding: 8px 16px; 
                                   border-radius: 15px; cursor: pointer; font-size: 12px; margin: 5px;">
                        üß™ Test Button
                    </button>
                </div>
            </div>

            <div id="candidate" class="container">
                <h1>Voting</h1>
                <p class="info"><b>Election Dates | </b><span id="dates">Loading Dates...</span></p>
                <table>
                    <thead>
                        <tr>
                            <th>
                                <i class="bi bi-person-raised-hand"></i>
                                Candidate
                            </th>
                            <th>
                                <i class="bi bi-flag-fill"></i>
                                Political Party
                            </th>
                            <th>
                                <i class="bi bi-graph-up-arrow"></i>
                                Total Vote
                            </th>
                        </tr>
                    </thead>
                    <tbody id="boxCandidate"></tbody>
                </table>
                <br />
                <p class="info" id="cantVote">You can't vote because no candidates have been declared.</p>
                <div id="vote">
                    <p class="info">Please select one of the candidates and click the ‚ÄúCast Vote‚Äù button.</p>
                    <button id="voteButton" class="btn btn-primary" onclick="App.vote()" disabled>Cast Vote</button>
                    <div id="msg"></div>

                    <div id="vote-box"></div>
                </div>
            </div>
        </main>

        <aside id="accessDenied">
            <h1>Official Detected!</h1>
            <p class="info">Redirecting to Commision Dashboard...</p>
        </aside>

        <aside id="noWallet">
            <h1>Wallet Required!</h1>
            <p class="info">To use this application, please install MetaMask cryptocurrency wallet extension for your
                browser and reload this page to verify you're a citizen, and thus eligible to interract with our system.
            </p>
            <p id="wallets">
                <a href="https://chrome.google.com/webstore/detail/metamask/nkbihfbeogaeaoehlefnkodbefgpgknn?utm"
                    target="_blank"><i class="bi bi-browser-chrome"></i><span>Chrome</span></a>
                <a href="https://microsoftedge.microsoft.com/addons/detail/metamask/ejbalbakoplchlghecdalmeeeajnimhm?hl=en-US&utm"
                    target="_blank"><i class="bi bi-browser-edge"></i><span>Edge</span></a>
                <a href="https://addons.mozilla.org/en-US/firefox/addon/ether-metamask/?utm" target="_blank"><i
                        class="bi bi-browser-firefox"></i><span>Firefox</span></a>
                <a href="https://metamask.io/en-GB/download" target="_blank"><i
                        class="bi bi-window"></i><span>Others</span></a>
            </p>
        </aside>
    </div>

    <!-- Load Web3 from CDN for better compatibility -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.4/dist/web3.min.js"></script>
    <script src="js/app.js"></script>
    <script src="js/zk-voting.js"></script>
    <script src="../dist/app.bundle.js"></script>
    <script src="js/metamask-fix.js"></script>
    <script src="js/simple-metamask.js"></script>
    <script src="js/emergency-bypass.js"></script>
    <script src="js/biometric-auth.js"></script>
    <script src="js/voting-debug.js"></script>
    <script src="js/quick-setup.js"></script>
    <script src="js/voting-fix.js"></script>
    <script src="js/metamask-circuit-breaker-fix.js"></script>
    
    <!-- Inline Debug Helper for immediate use -->
    <script>
        // Simple debug function available immediately
        window.debugVoting = function() {
            console.log('=== BLOCKELECT VOTING DEBUG ===');
            console.log('1. App available:', typeof App !== 'undefined');
            console.log('2. App.account:', App?.account || 'Not connected');
            console.log('3. App.contract:', App?.contract ? 'Initialized' : 'Not initialized');
            console.log('4. App.selectedCandidate:', App?.selectedCandidate);
            console.log('5. MetaMask:', typeof window.ethereum !== 'undefined' ? 'Available' : 'Not found');
            
            if (App?.contract && App?.account) {
                App.contract.methods.startDate().call().then(startDate => {
                    App.contract.methods.endDate().call().then(endDate => {
                        const now = Math.floor(Date.now() / 1000);
                        console.log('6. Election Dates:');
                        console.log('   Start:', Number(startDate), new Date(Number(startDate) * 1000));
                        console.log('   End:', Number(endDate), new Date(Number(endDate) * 1000));
                        console.log('   Now:', now, new Date(now * 1000));
                        console.log('   Active:', now >= Number(startDate) && now <= Number(endDate));
                        console.log('   Dates Set:', Number(startDate) > 0 && Number(endDate) > 0);
                    });
                });
            }
            console.log('=== Run debugVoting() anytime for status ===');
        };
        
        // Auto-run after page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (typeof App !== 'undefined') {
                    console.log('üîß Debug helper loaded. Run debugVoting() for system status.');
                }
            }, 3000);
        });
        
        // Biometric button function
        function openBiometricAuth() {
            console.log('üîê Biometric button clicked!');
            
            // First, try to open existing modal
            const existingModal = document.getElementById('biometric-auth-modal');
            if (existingModal) {
                console.log('‚úÖ Found existing modal, showing it');
                existingModal.style.display = 'flex';
                return;
            }
            
            // Try multiple ways to open biometric auth
            if (typeof biometricAuth !== 'undefined' && biometricAuth.showBiometricAuth) {
                console.log('üîê Opening biometric auth via biometricAuth');
                biometricAuth.showBiometricAuth();
            } else if (typeof window.biometricAuth !== 'undefined' && window.biometricAuth.showBiometricAuth) {
                console.log('üîê Opening biometric auth via window.biometricAuth');
                window.biometricAuth.showBiometricAuth();
            } else {
                console.log('üîê Creating immediate fallback modal');
                // Create simple biometric modal immediately
                createImmediateBiometricModal();
            }
        }
        
        // Create immediate biometric modal as fallback
        function createImmediateBiometricModal() {
            console.log('üõ†Ô∏è Creating immediate biometric modal...');
            
            // Remove any existing modal first
            const existing = document.getElementById('biometric-auth-modal');
            if (existing) existing.remove();
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'biometric-auth-modal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
                            background: rgba(0,0,0,0.9); z-index: 999999; display: flex !important;
                            justify-content: center; align-items: center; overflow: auto;">
                    <div style="background: white; padding: 30px; border-radius: 15px; 
                                max-width: 500px; width: 90%; text-align: center; 
                                box-shadow: 0 20px 60px rgba(0,0,0,0.5); position: relative; z-index: 1000000;">
                        <h2 style="color: #007bff; margin-bottom: 20px; font-weight: bold;">
                            üîê Biometric Voter Authentication
                        </h2>
                        
                        <div id="biometric-status" style="margin-bottom: 20px; color: #666;">
                            Click "Start Camera" to begin face recognition
                        </div>
                        
                        <div style="position: relative; margin: 20px 0;">
                            <video id="biometric-video" width="320" height="240" autoplay muted 
                                   style="border: 3px solid #007bff; border-radius: 10px; background: #000;"></video>
                            <canvas id="biometric-canvas" width="320" height="240" 
                                    style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <button onclick="startSimpleCamera()" 
                                    style="background: #28a745; color: white; padding: 12px 24px; 
                                           border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin: 5px;">
                                üì∑ Start Camera
                            </button>
                            
                            <button onclick="simulateRegistration()" 
                                    style="background: #17a2b8; color: white; padding: 12px 24px; 
                                           border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin: 5px;">
                                üìù Register Voter
                            </button>
                            
                            <button onclick="simulateVerification()" 
                                    style="background: #007bff; color: white; padding: 12px 24px; 
                                           border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin: 5px;">
                                ‚úÖ Verify Identity
                            </button>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button onclick="closeBiometricModal()" 
                                    style="background: #6c757d; color: white; padding: 8px 16px; 
                                           border: none; border-radius: 5px; cursor: pointer;">
                                Close
                            </button>
                            
                            <button onclick="useTraditionalAuth()" 
                                    style="background: #ffc107; color: #000; padding: 8px 16px; 
                                           border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                                Use Traditional Login
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('‚úÖ Immediate biometric modal created and shown');
        }
        
        // Simple biometric functions
        function startSimpleCamera() {
            console.log('üì∑ Starting simple camera...');
            const video = document.getElementById('biometric-video');
            const status = document.getElementById('biometric-status');
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false })
                .then(stream => {
                    video.srcObject = stream;
                    status.textContent = '‚úÖ Camera active! Position your face in the frame';
                    status.style.color = '#28a745';
                    
                    // Simulate face detection after 2 seconds
                    setTimeout(() => {
                        status.textContent = 'üë§ Face detected! Ready for registration or verification';
                        
                        // Draw face detection rectangle
                        const canvas = document.getElementById('biometric-canvas');
                        const ctx = canvas.getContext('2d');
                        ctx.strokeStyle = '#00ff00';
                        ctx.lineWidth = 3;
                        ctx.strokeRect(80, 60, 160, 120);
                        ctx.fillStyle = '#00ff00';
                        ctx.font = '14px Arial';
                        ctx.fillText('Face Detected', 85, 55);
                    }, 2000);
                })
                .catch(err => {
                    console.error('Camera error:', err);
                    status.textContent = '‚ùå Camera access denied. Please enable camera permissions.';
                    status.style.color = '#dc3545';
                });
        }
        
        function simulateRegistration() {
            const status = document.getElementById('biometric-status');
            status.textContent = 'üìù Registering biometric data...';
            status.style.color = '#17a2b8';
            
            setTimeout(() => {
                const voterID = 'VTR' + Math.random().toString(36).substring(2, 6).toUpperCase();
                alert(`üéâ Registration Successful!\n\nVoter ID: ${voterID}\n\nYour biometric data has been registered.`);
                status.textContent = `‚úÖ Registered as Voter ${voterID}`;
                status.style.color = '#28a745';
            }, 1500);
        }
        
        function simulateVerification() {
            const status = document.getElementById('biometric-status');
            status.textContent = 'üîç Verifying identity...';
            status.style.color = '#007bff';
            
            setTimeout(() => {
                const voterID = 'VTR' + Math.random().toString(36).substring(2, 6).toUpperCase();
                alert(`‚úÖ Verification Successful!\n\nWelcome, Voter ${voterID}!\n\nYou are now authenticated.`);
                closeBiometricModal();
                
                // Show authentication status
                const authStatus = document.createElement('div');
                authStatus.style.cssText = `
                    position: fixed; top: 10px; left: 10px; background: #28a745; 
                    color: white; padding: 10px 15px; border-radius: 8px; 
                    font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 9999;
                `;
                authStatus.textContent = `üîê Authenticated: Voter ${voterID}`;
                document.body.appendChild(authStatus);
            }, 1500);
        }
        
        function closeBiometricModal() {
            const modal = document.getElementById('biometric-auth-modal');
            if (modal) {
                // Stop any camera streams
                const video = document.getElementById('biometric-video');
                if (video && video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
                modal.remove();
            }
        }
        
        function useTraditionalAuth() {
            closeBiometricModal();
            const userID = prompt('Traditional Authentication\n\nEnter your Voter ID or Name:');
            if (userID) {
                alert(`‚úÖ Traditional Authentication Successful!\n\nWelcome, ${userID}!`);
                
                const authStatus = document.createElement('div');
                authStatus.style.cssText = `
                    position: fixed; top: 10px; left: 10px; background: #ffc107; 
                    color: #000; padding: 10px 15px; border-radius: 8px; 
                    font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 9999;
                `;
                authStatus.textContent = `üîë Traditional Auth: ${userID}`;
                document.body.appendChild(authStatus);
            }
        }
        
        // IMMEDIATE TEST FUNCTION - Run this in console if button still doesn't work
        window.forceShowBiometricModal = function() {
            console.log('üöë EMERGENCY: Force showing biometric modal...');
            
            // Remove any existing modals first
            const existing = document.querySelectorAll('#biometric-auth-modal, [id*="biometric"]');
            existing.forEach(el => el.remove());
            
            // Create ultra-high priority modal
            const emergencyModal = document.createElement('div');
            emergencyModal.id = 'emergency-biometric-modal';
            emergencyModal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background: rgba(0,0,0,0.95) !important;
                z-index: 2147483647 !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                font-family: Arial, sans-serif !important;
            `;
            
            emergencyModal.innerHTML = `
                <div style="background: white !important; padding: 30px !important; border-radius: 15px !important;
                            max-width: 500px !important; width: 90% !important; text-align: center !important;
                            box-shadow: 0 20px 60px rgba(0,0,0,0.8) !important; position: relative !important;">
                    <h2 style="color: #007bff !important; margin-bottom: 20px !important; font-weight: bold !important;">
                        üîê EMERGENCY Biometric Test
                    </h2>
                    
                    <p style="margin-bottom: 20px !important; color: #666 !important;">
                        ‚úÖ Modal is working! Click buttons below to test:
                    </p>
                    
                    <div style="margin: 20px 0 !important;">
                        <button onclick="alert('üì∑ Camera test would start here!')" 
                                style="background: #28a745 !important; color: white !important; padding: 12px 24px !important;
                                       border: none !important; border-radius: 8px !important; font-weight: bold !important; 
                                       cursor: pointer !important; margin: 5px !important;">
                            üì∑ Test Camera
                        </button>
                        
                        <button onclick="alert('üìù Registration test - Working!')" 
                                style="background: #17a2b8 !important; color: white !important; padding: 12px 24px !important;
                                       border: none !important; border-radius: 8px !important; font-weight: bold !important; 
                                       cursor: pointer !important; margin: 5px !important;">
                            üìù Test Register
                        </button>
                        
                        <button onclick="alert('‚úÖ Verification test - Working!')" 
                                style="background: #007bff !important; color: white !important; padding: 12px 24px !important;
                                       border: none !important; border-radius: 8px !important; font-weight: bold !important; 
                                       cursor: pointer !important; margin: 5px !important;">
                            ‚úÖ Test Verify
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px !important;">
                        <button onclick="document.getElementById('emergency-biometric-modal').remove()" 
                                style="background: #dc3545 !important; color: white !important; padding: 10px 20px !important;
                                       border: none !important; border-radius: 5px !important; cursor: pointer !important;">
                            Close Emergency Modal
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(emergencyModal);
            console.log('‚úÖ Emergency biometric modal created and should be visible!');
        }
        
        // Test function for biometric button
        function testBiometricButton() {
            console.log('üß™ Testing biometric button functionality');
            const btn = document.getElementById('biometric-btn');
            if (btn) {
                console.log('‚úÖ Biometric button found in DOM');
                btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                btn.textContent = '‚úÖ Button Working!';
                setTimeout(() => {
                    btn.style.background = 'linear-gradient(45deg, #007bff, #0056b3)';
                    btn.textContent = 'üîê Enable Biometric Login';
                }, 2000);
            } else {
                console.error('‚ùå Biometric button not found in DOM');
            }
        }
    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('[PWA] Service Worker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.error('[PWA] Service Worker registration failed:', error);
                    });
            });
        }
        
        // PWA Install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button or notification
            console.log('[PWA] Install prompt available');
        });
    </script>
</body>

</html>